---
/**
 * BMI Calculator Component - Regionally Adapted with Tailwind & DaisyUI
 *
 * Features:
 * - Modern design with Tailwind CSS and DaisyUI
 * - Adapts to regional preferences (units, thresholds, categories)
 * - Asian BMI thresholds for Hindi (India)
 * - 8 WHO categories for detailed analysis (most languages)
 * - 4 WHO categories for simplified UI (Dutch, Swedish)
 * - Responsive and accessible
 */
import { t, type Locale } from '@/utils/i18n';
import { getBMIRegionalConfig, usesAsianThresholds, getDefaultUnitSystem, getBMICategoryCount } from '@/config/bmi-regional';

const { lang } = Astro.props as { lang: Locale };
const regionalConfig = getBMIRegionalConfig(lang);
const isAsian = usesAsianThresholds(lang);
const defaultUnit = getDefaultUnitSystem(lang);
const categoryCount = getBMICategoryCount(lang);

// Determine threshold type for calculations
let thresholdType: 'WHO_8' | 'WHO_4' | 'ASIAN' = 'WHO_8';
if (isAsian) {
  thresholdType = 'ASIAN';
} else if (categoryCount === 4) {
  thresholdType = 'WHO_4';
}
---

<div class="max-w-5xl mx-auto">
  <!-- Calculator Form Card -->
  <div class="card bg-base-100 shadow-xl mb-8">
    <div class="card-body">
      <h2 class="card-title text-2xl mb-6">{t('bmi.form.title', lang)}</h2>

      <form id="bmi-form" class="space-y-6">
        <!-- Unit System Toggle -->
        <div class="form-control">
          <fieldset class="flex gap-4 p-4 bg-base-200 rounded-lg">
            <legend class="sr-only">{t('units.system', lang)}</legend>
            <label class="label cursor-pointer gap-2">
              <input
                type="radio"
                name="unitSystem"
                value="metric"
                class="radio radio-primary"
                checked={defaultUnit === 'metric'}
              />
              <span class="label-text font-medium">{t('units.metric', lang)}</span>
            </label>
            <label class="label cursor-pointer gap-2">
              <input
                type="radio"
                name="unitSystem"
                value="imperial"
                class="radio radio-primary"
                checked={defaultUnit === 'imperial'}
              />
              <span class="label-text font-medium">{t('units.imperial', lang)}</span>
            </label>
          </fieldset>
        </div>

        <!-- Age & Gender Row -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Age -->
          <div class="form-control">
            <label class="label" for="age">
              <span class="label-text font-medium">{t('bmi.form.ageLabel', lang)}</span>
            </label>
            <input
              type="number"
              id="age"
              name="age"
              min="2"
              max="120"
              required
              placeholder={t('bmi.form.agePlaceholder', lang)}
              class="input input-bordered w-full"
            />
            <label class="label">
              <span class="label-text-alt text-base-content/60">{t('common.years', lang)}</span>
            </label>
          </div>

          <!-- Gender -->
          <div class="form-control">
            <label class="label" for="gender">
              <span class="label-text font-medium">{t('bmi.form.genderLabel', lang)}</span>
            </label>
            <select id="gender" name="gender" required class="select select-bordered w-full">
              <option value="male">{t('common.male', lang)}</option>
              <option value="female">{t('common.female', lang)}</option>
            </select>
          </div>
        </div>

        <!-- Height (Metric) -->
        <div class="form-control height-metric" style={defaultUnit === 'imperial' ? 'display: none;' : ''}>
          <label class="label" for="height">
            <span class="label-text font-medium">{t('bmi.form.heightLabel', lang)}</span>
          </label>
          <input
            type="number"
            id="height"
            name="height"
            min="50"
            max="250"
            step="0.1"
            required={defaultUnit === 'metric'}
            placeholder={t('bmi.form.heightPlaceholder', lang)}
            class="input input-bordered w-full"
          />
          <label class="label">
            <span class="label-text-alt text-base-content/60">{t('units.cm', lang)}</span>
          </label>
        </div>

        <!-- Height (Imperial) -->
        <div class="form-control height-imperial" style={defaultUnit === 'metric' ? 'display: none;' : ''}>
          <label class="label" for="heightFt">
            <span class="label-text font-medium">{t('bmi.form.heightLabel', lang)}</span>
          </label>
          <div class="flex gap-3">
            <div class="flex-1">
              <input
                type="number"
                id="heightFt"
                name="heightFt"
                min="1"
                max="8"
                required={defaultUnit === 'imperial'}
                placeholder={t('units.ft', lang)}
                aria-label={t('units.ft', lang)}
                class="input input-bordered w-full"
              />
              <label class="label">
                <span class="label-text-alt text-base-content/60">{t('units.ft', lang)}</span>
              </label>
            </div>
            <div class="flex-1">
              <input
                type="number"
                id="heightIn"
                name="heightIn"
                min="0"
                max="11"
                required={defaultUnit === 'imperial'}
                placeholder={t('units.in', lang)}
                aria-label={t('units.in', lang)}
                class="input input-bordered w-full"
              />
              <label class="label">
                <span class="label-text-alt text-base-content/60">{t('units.in', lang)}</span>
              </label>
            </div>
          </div>
        </div>

        <!-- Weight -->
        <div class="form-control">
          <label class="label" for="weight">
            <span class="label-text font-medium">{t('bmi.form.weightLabel', lang)}</span>
          </label>
          <input
            type="number"
            id="weight"
            name="weight"
            min="10"
            max="500"
            step="0.1"
            required
            placeholder={t('bmi.form.weightPlaceholder', lang)}
            class="input input-bordered w-full"
          />
          <label class="label">
            <span class="label-text-alt text-base-content/60 weight-unit">{defaultUnit === 'imperial' ? t('units.lbs', lang) : t('units.kg', lang)}</span>
          </label>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-3 mt-6">
          <button type="submit" class="btn btn-primary flex-1 text-lg">
            {t('common.calculate', lang)}
          </button>
          <button type="reset" class="btn btn-outline flex-1 text-lg">
            {t('common.reset', lang)}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Calculating Animation -->
  <div id="calculating-animation" class="card bg-base-100 shadow-xl mb-8" style="display: none;">
    <div class="card-body items-center text-center">
      <div class="w-48 mb-6">
        <svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
          <!-- Background arc -->
          <path
            d="M 30 100 A 70 70 0 0 1 170 100"
            fill="none"
            stroke="oklch(var(--bc) / 0.2)"
            stroke-width="12"
            stroke-linecap="round"
          />
          <!-- Animated progress arc -->
          <path
            id="progress-arc"
            d="M 30 100 A 70 70 0 0 1 170 100"
            fill="none"
            stroke="url(#gradient)"
            stroke-width="12"
            stroke-linecap="round"
            stroke-dasharray="220"
            stroke-dashoffset="220"
          />
          <!-- Center circle pulse -->
          <circle cx="100" cy="100" r="20" fill="oklch(var(--p))" opacity="0.3" class="pulse-circle"/>
          <circle cx="100" cy="100" r="15" fill="oklch(var(--p))" class="pulse-circle-small"/>

          <!-- Gradient definition -->
          <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:oklch(var(--p));stop-opacity:1" />
              <stop offset="50%" style="stop-color:oklch(var(--s));stop-opacity:1" />
              <stop offset="100%" style="stop-color:oklch(var(--a));stop-opacity:1" />
            </linearGradient>
          </defs>
        </svg>
      </div>
      <p class="text-xl font-semibold text-primary">{t('bmi.results.title', lang)}...</p>
      <div class="flex gap-2 mt-4">
        <span class="loading loading-dots loading-lg text-primary"></span>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div id="results" style="display: none;" role="region" aria-live="polite" aria-atomic="true">
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title text-2xl mb-6">{t('bmi.results.title', lang)}</h2>

        <!-- BMI Value Card -->
        <div id="result-card" class="card bg-primary text-primary-content shadow-lg mb-8">
          <div class="card-body items-center text-center">
            <h3 class="card-title text-lg">{t('bmi.results.bmiValue', lang)}</h3>
            <p id="bmi-value" class="text-6xl font-bold my-4">-</p>
            <p id="bmi-category" class="text-xl font-semibold mb-2">-</p>
            <div id="risk-level" class="badge badge-lg badge-outline border-primary-content text-primary-content">-</div>
          </div>
        </div>

        <!-- Results Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
          <div class="stat bg-base-200 rounded-lg shadow hover:shadow-lg transition-shadow">
            <div class="stat-title">{t('bmi.results.bmiPrime', lang)}</div>
            <div id="bmi-prime" class="stat-value text-primary">-</div>
          </div>
          <div class="stat bg-base-200 rounded-lg shadow hover:shadow-lg transition-shadow">
            <div class="stat-title">{t('bmi.results.ponderalIndex', lang)}</div>
            <div id="ponderal-index" class="stat-value text-primary">-</div>
          </div>
          <div class="stat bg-base-200 rounded-lg shadow hover:shadow-lg transition-shadow">
            <div class="stat-title">{t('bmi.results.healthyRange', lang)}</div>
            <div id="healthy-bmi" class="stat-value text-secondary text-2xl">-</div>
          </div>
          <div class="stat bg-base-200 rounded-lg shadow hover:shadow-lg transition-shadow">
            <div class="stat-title">{t('bmi.results.healthyWeight', lang)}</div>
            <div id="healthy-weight" class="stat-value text-secondary text-2xl">-</div>
          </div>
        </div>

        <!-- Disclaimer -->
        <div class="alert alert-warning shadow-lg">
          <div class="w-full">
            <div class="flex items-start gap-2 mb-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
              <h4 class="font-bold">{t('bmi.disclaimer.title', lang)}</h4>
            </div>
            <ul class="list-disc list-inside space-y-1 ml-8 text-sm">
              <li>{t('bmi.disclaimer.point1', lang)}</li>
              <li>{t('bmi.disclaimer.point2', lang)}</li>
              <li>{t('bmi.disclaimer.point3', lang)}</li>
              <li>{t('bmi.disclaimer.point4', lang)}</li>
              {isAsian && (
                <li><strong>{t('bmi.disclaimer.asianNote', lang)}</strong></li>
              )}
            </ul>
            <p class="text-xs italic mt-3 opacity-80">
              {t('bmi.disclaimer.source', lang)}: {regionalConfig.healthAuthority}
            </p>
          </div>
        </div>

        <!-- Privacy Note (for Swedish market) -->
        {regionalConfig.features.privacyNote && (
          <div class="alert alert-success shadow-lg mt-4">
            <div>
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              <span class="text-sm">ðŸ”’ {t('bmi.privacy.note', lang)}</span>
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</div>

<style>
  /* Progress arc animation */
  #progress-arc {
    animation: fillProgress 2s ease-out forwards;
  }

  @keyframes fillProgress {
    from {
      stroke-dashoffset: 220;
    }
    to {
      stroke-dashoffset: 0;
    }
  }

  /* Pulse animations */
  .pulse-circle {
    animation: pulse 1.5s ease-in-out infinite;
  }

  .pulse-circle-small {
    animation: pulseSmall 1.5s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      r: 20;
      opacity: 0.3;
    }
    50% {
      r: 25;
      opacity: 0.1;
    }
  }

  @keyframes pulseSmall {
    0%, 100% {
      r: 15;
      opacity: 1;
    }
    50% {
      r: 18;
      opacity: 0.7;
    }
  }

  /* Category-specific colors for result card */
  .category-severe-thinness,
  .category-moderate-thinness,
  .category-mild-thinness,
  .category-underweight {
    @apply bg-info text-info-content;
  }

  .category-normal {
    @apply bg-success text-success-content;
  }

  .category-pre-obese,
  .category-overweight {
    @apply bg-warning text-warning-content;
  }

  .category-obese-i,
  .category-obese-ii,
  .category-obese-iii,
  .category-obese {
    @apply bg-error text-error-content;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    #progress-arc,
    .pulse-circle,
    .pulse-circle-small {
      animation: none;
    }
  }
</style>

<script is:inline define:vars={{ lang, thresholdType, isAsian, defaultUnit }}>
  // Get DOM elements
  const form = document.getElementById('bmi-form');
  const results = document.getElementById('results');
  const unitSystemInputs = document.querySelectorAll('input[name="unitSystem"]');
  const heightMetric = document.querySelector('.height-metric');
  const heightImperial = document.querySelector('.height-imperial');
  const weightUnit = document.querySelector('.weight-unit');

  // Handle unit system change
  unitSystemInputs.forEach(input => {
    input.addEventListener('change', (e) => {
      const target = e.target;
      const isMetric = target.value === 'metric';

      heightMetric.style.display = isMetric ? 'block' : 'none';
      heightImperial.style.display = isMetric ? 'none' : 'block';

      const heightInput = document.getElementById('height');
      const heightFt = document.getElementById('heightFt');
      const heightIn = document.getElementById('heightIn');

      if (isMetric) {
        heightInput.required = true;
        heightFt.required = false;
        heightIn.required = false;
        weightUnit.textContent = lang === 'en' ? 'kg' : 'kg';
      } else {
        heightInput.required = false;
        heightFt.required = true;
        heightIn.required = true;
        weightUnit.textContent = 'lbs';
      }
    });
  });

  // Load translations
  let translations = null;
  async function loadTranslations() {
    if (!translations) {
      const response = await fetch(`/locales/${lang}/calculators/bmi.json`);
      translations = await response.json();
    }
    return translations;
  }

  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Show calculating animation
    showCalculatingAnimation();

    const formData = new FormData(form);
    const unitSystem = formData.get('unitSystem');
    const age = parseInt(formData.get('age'));
    const gender = formData.get('gender');
    const weight = parseFloat(formData.get('weight'));

    let height;

    if (unitSystem === 'metric') {
      height = parseFloat(formData.get('height'));
    } else {
      const feet = parseInt(formData.get('heightFt')) || 0;
      const inches = parseInt(formData.get('heightIn')) || 0;
      height = feet * 12 + inches; // Total inches
    }

    const input = {
      age,
      gender,
      height,
      weight,
      unitSystem,
      thresholdType,
    };

    try {
      // Load translations and calculate
      const [{ calculateBMIMetrics }, trans] = await Promise.all([
        import('/src/utils/calculators/bmi.ts'),
        loadTranslations(),
        new Promise(resolve => setTimeout(resolve, 2000)) // 2 second animation
      ]);

      const result = calculateBMIMetrics(input);
      displayResults(result, unitSystem, trans);
    } catch (error) {
      alert('Error calculating BMI. Please check your inputs.');
      console.error(error);
      hideCalculatingAnimation();
    }
  });

  function showCalculatingAnimation() {
    const calculatingDiv = document.getElementById('calculating-animation');
    if (calculatingDiv) {
      calculatingDiv.style.display = 'block';
    }
  }

  function hideCalculatingAnimation() {
    const calculatingDiv = document.getElementById('calculating-animation');
    if (calculatingDiv) {
      calculatingDiv.style.display = 'none';
    }
  }

  function displayResults(result, unitSystem, trans) {
    // Hide calculating animation
    hideCalculatingAnimation();

    const bmiValue = document.getElementById('bmi-value');
    const bmiCategory = document.getElementById('bmi-category');
    const riskLevel = document.getElementById('risk-level');
    const bmiPrime = document.getElementById('bmi-prime');
    const ponderalIndex = document.getElementById('ponderal-index');
    const healthyBMI = document.getElementById('healthy-bmi');
    const healthyWeight = document.getElementById('healthy-weight');
    const resultCard = document.getElementById('result-card');

    // Update values
    bmiValue.textContent = result.bmi.toString();

    // Get translated category name
    const categoryKey = result.categoryDetails.code.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
    bmiCategory.textContent = trans.categories[categoryKey] || result.categoryDetails.code;

    // Show risk level with translations
    const riskLevelMap = {
      'very-high': trans.riskLevel.veryHigh,
      'high': trans.riskLevel.high,
      'moderate': trans.riskLevel.moderate,
      'low': trans.riskLevel.low
    };
    riskLevel.textContent = riskLevelMap[result.categoryDetails.riskLevel];

    bmiPrime.textContent = result.bmiPrime.toString();
    ponderalIndex.textContent = result.ponderalIndex.toString();
    healthyBMI.textContent = `${result.healthyBMIRange.min} - ${result.healthyBMIRange.max}`;

    const weightUnitText = unitSystem === 'metric' ? 'kg' : 'lbs';
    healthyWeight.textContent = `${result.healthyWeightRange.min} - ${result.healthyWeightRange.max} ${weightUnitText}`;

    // Update result card color based on category
    resultCard.className = `card shadow-lg mb-8 category-${result.category}`;

    // Show results and scroll to them
    results.style.display = 'block';
    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  // Handle form reset
  form.addEventListener('reset', () => {
    results.style.display = 'none';
  });
</script>
