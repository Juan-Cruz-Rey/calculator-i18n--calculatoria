---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCategoriesWithTranslations } from '@/config/calculator-categories';
import { calculatorPaths } from '@/utils/i18n';
import type { CalculatorId } from '@/config/calculators';

const lang = 'en';
const categoriesData = getCategoriesWithTranslations(lang);

// Helper to convert calculator ID to camelCase for accessing calculatorPaths
function kebabToCamelCase(str: string): string {
  return str.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
}

// Helper to get calculator translation
async function getCalculatorInfo(calculatorId: CalculatorId) {
  try {
    const translation = await import(`../../../public/locales/en/calculators/${calculatorId}.json`);
    return {
      title: translation.title || calculatorId,
      description: translation.description || ''
    };
  } catch (e) {
    return {
      title: calculatorId,
      description: ''
    };
  }
}

// Get all calculator info
const categoriesWithCalculators = await Promise.all(
  categoriesData.map(async (category) => {
    const calculators = await Promise.all(
      category.calculators.map(async (calcId) => {
        const info = await getCalculatorInfo(calcId);
        const camelCaseId = kebabToCamelCase(calcId);
        return {
          id: calcId,
          ...info,
          path: calculatorPaths[camelCaseId][lang]
        };
      })
    );
    return {
      ...category,
      calculators
    };
  })
);

const totalCalculators = categoriesData.reduce((acc, cat) => acc + cat.calculators.length, 0);
---

<BaseLayout
  title="Free Online Calculators | Calculatoria"
  description={`Discover ${totalCalculators} free calculators organized by category: health, nutrition, pregnancy, fitness, and more. Accurate and easy-to-use tools.`}
  lang={lang}
  keywords="online calculators, free calculator, calculation tools, health calculator, BMI calculator, calorie calculator, pregnancy calculator"
>
  <!-- Header Section -->
  <div class="bg-gradient-to-r from-primary/10 via-secondary/10 to-accent/10 py-12">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-base-content mb-4">Online Calculators</h1>
      <p class="text-lg md:text-xl text-base-content/70 max-w-3xl mx-auto">
        Explore our collection of {totalCalculators} free and accurate calculators for health, nutrition, fitness, and more.
      </p>
    </div>
  </div>

  <!-- Categories Section -->
  <div class="container mx-auto px-4 py-12">
    {categoriesWithCalculators.map((category) => (
      <section class="mb-16">
        <!-- Category Header -->
        <div class="mb-8">
          <h2 class="text-3xl font-bold text-primary mb-3">{category.name}</h2>
          <p class="text-base-content/70 text-lg">{category.description}</p>
        </div>

        <!-- Calculators Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {category.calculators.map((calc) => (
            <a
              href={calc.path}
              class="card bg-base-100 shadow-md hover:shadow-xl transition-all duration-300 hover:-translate-y-1 border border-base-300 hover:border-primary group"
            >
              <div class="card-body p-5">
                <h3 class="card-title text-base group-hover:text-primary transition-colors">
                  {calc.title}
                </h3>
                {calc.description && (
                  <p class="text-sm text-base-content/60 line-clamp-2">{calc.description}</p>
                )}
                <div class="card-actions justify-end mt-2">
                  <span class="text-primary text-sm font-medium group-hover:translate-x-1 transition-transform inline-flex items-center gap-1">
                    Calculate →
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </section>
    ))}
  </div>

  <!-- CTA Section -->
  <div class="bg-base-200 py-12">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Need a specific calculator?</h2>
      <p class="text-lg text-base-content/70 mb-6 max-w-2xl mx-auto">
        We're constantly adding new calculators. If you can't find what you're looking for, let us know!
      </p>
      <div class="flex flex-wrap gap-3 justify-center">
        <a href="/" class="btn btn-primary btn-lg">
          Back to Home
        </a>
        <a href="#top" class="btn btn-outline btn-lg">
          Back to Top ↑
        </a>
      </div>
    </div>
  </div>
</BaseLayout>
