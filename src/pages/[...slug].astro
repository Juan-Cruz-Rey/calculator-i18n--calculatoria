---
/**
 * Dynamic routing for all calculator pages
 *
 * This file handles ALL calculator URLs across all languages using Astro's
 * [...slug] pattern. It generates static paths for every calculator in every
 * supported language, then renders the appropriate MDX content.
 *
 * URL Examples:
 * - Spanish (default): /calculadoras/imc/
 * - English: /en/calculators/bmi/
 * - German: /de/rechner/bmi/
 * - French: /fr/calculatrices/imc/
 *
 * Benefits:
 * - Single source of truth for calculator pages
 * - Adding a new calculator = update config + create MDX files
 * - Adding a new language = update config + create MDX files
 * - SEO-preserved: URLs remain identical to current structure
 */

import type { GetStaticPaths } from 'astro';
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { languages, defaultLocale, type Locale } from '@/config/languages';
import { calculators, type CalculatorId } from '@/config/calculators';
import { getSlug } from '@/config/routes';

export const getStaticPaths = (async () => {
  const paths = [];

  // Get all available MDX entries
  const allEntries = await getCollection('calculators');

  // Generate paths only for calculators that have MDX files
  for (const entry of allEntries) {
    // Parse the entry id: "lang/calculator-id.mdx"
    const [lang, calcFile] = entry.id.split('/');
    const calculatorId = calcFile.replace('.mdx', '') as CalculatorId;

    const langConfig = languages[lang as Locale];
    if (!langConfig) continue;

    const slug = getSlug(calculatorId, lang as Locale);

    // Build the full path based on language
    let fullPath: string;
    if (lang === defaultLocale) {
      // English (default) has no language prefix
      fullPath = `${langConfig.folder}/${slug}`;
    } else {
      // Other languages include language code
      fullPath = `${lang}/${langConfig.folder}/${slug}`;
    }

    paths.push({
      params: { slug: fullPath },
      props: {
        lang: lang as Locale,
        calculatorId,
      }
    });
  }

  return paths;
}) satisfies GetStaticPaths;

// Get props from getStaticPaths
const { lang, calculatorId } = Astro.props;

// Load the MDX content for this calculator in this language
const allEntries = await getCollection('calculators');
const entry = allEntries.find(e => e.id === `${lang}/${calculatorId}.mdx`);

if (!entry) {
  // This should never happen in production since getStaticPaths only generates
  // paths for calculators that have MDX files
  throw new Error(`MDX content not found for ${lang}/${calculatorId}`);
}

const { Content } = await entry.render();
const { title, metaDescription: description } = entry.data;
---

<BaseLayout
  title={title}
  description={description}
  lang={lang}
  calculator={calculatorId}
>
  <div class="container">
    <div class="calculator-page">
      <div class="content-wrapper">
        <Content />
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .calculator-page {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .content-wrapper {
    line-height: 1.6;
  }

  .content-wrapper :global(h1) {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #1a202c;
  }

  .content-wrapper :global(h2) {
    font-size: 2rem;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #2d3748;
  }

  .content-wrapper :global(h3) {
    font-size: 1.5rem;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: #4a5568;
  }

  .content-wrapper :global(p) {
    margin-bottom: 1rem;
    color: #4a5568;
  }

  .content-wrapper :global(ul),
  .content-wrapper :global(ol) {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .content-wrapper :global(li) {
    margin-bottom: 0.5rem;
  }

  .content-wrapper :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }

  .content-wrapper :global(th),
  .content-wrapper :global(td) {
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    text-align: left;
  }

  .content-wrapper :global(th) {
    background-color: #f7fafc;
    font-weight: 600;
  }
</style>
